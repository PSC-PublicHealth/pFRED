#!/usr/bin/perl
use strict;
use warnings;
use Env;
use Cwd;
use Fcntl qw(:flock);
use Getopt::Std;
use POSIX qw/ceil/;
$| = 1;  # AUTO_FLUSH

# File: run_fred
# Author: John Grefenstette
# Created: Apr 7, 2011
# Updated: Apr 7, 2011

# get current working directory
my $cwd = getcwd();

my $FRED = $ENV{FRED_HOME};
die "run_fred: Please set environmental variable FRED_HOME to location of FRED home directory\n" if not $FRED;

my @arg = @ARGV;

# get command line arguments
my %options = ();
getopts("d:p:s:n:", \%options);

my $paramsfile = "params";
$paramsfile = $options{p} if exists $options{p};
die "usage: run_fred -d dir -p params -s start_run -n end_run\n" if $paramsfile =~ /[\"\';]/;

my $dir = "";
$dir = $options{d} if exists $options{d};
die "usage: run_fred -d dir -p params -s start_run -n end_run\n" if $dir =~ /[\"\';]/;
if ($dir eq "") {
  $dir = get_param_value("outdir", $paramsfile);
}
if (not -d $dir) { mkdir $dir }
`cp $paramsfile $dir` if $dir ne ".";

my $start_run = 1;
$start_run = $options{s} if exists $options{s};
die "usage: run_fred -d dir -p params -s start_run -n end_run\n" if $start_run =~ /\D/;

my $end_run = $start_run;
$end_run = $options{n} if exists $options{n};
die "usage: run_fred -d dir -p params -s start_run -n end_run\n" if $start_run =~ /\D/;
$end_run = $start_run if $end_run < $start_run;
die "usage: run_fred -d dir -p params -s start_run -n end_run\n" if $end_run =~ /\D/;

my $cmd = "'run_fred @arg'";
system "echo $cmd > $dir/COMMAND_LINE";
for my $n ($start_run .. $end_run) {
  $cmd = "FRED $paramsfile $n $dir > $dir/LOG$n";
  print "$cmd\n";
  system $cmd;
}


sub get_param_value {
  my ($param, $paramsfile) = @_;
  $param =~ s/\[/\\[/g;
  $param =~ s/\-/\\-/g;
  my $dval = `grep '$param =' params.def`;
  chomp $dval;
  my @a = split " ", $dval;
  $dval = pop @a;
  return "" if not $dval;
  # print "dval = |$dval|\n";
  my $pval = `grep '$param =' $paramsfile`;
  if ($pval) {
    @a = split " ", $pval;
    $pval = pop @a;
  }
  # print "pval = |$pval|\n";
  return $pval if $pval;
  return $dval if $dval;
  return "";
}


