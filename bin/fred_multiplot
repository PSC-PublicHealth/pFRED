#!/usr/bin/perl
use strict;
use warnings;
use Env;

my $FRED = $ENV{FRED_HOME};
die "Please set environmental variable FRED_HOME to location of FRED home directory\n" if not $FRED;

my $gnuplot = $ENV{FRED_GNUPLOT};
die "no gnuplot\n" if (not $gnuplot or (not -x $gnuplot));

my @args = @ARGV;
die "usage: fred_multiplot -v var -k key1 key2 ...\n" if $args[0] ne "-v";
die "usage: fred_multiplot -v var -k key1 key2 ...\n" if $args[2] ne "-k";
my $v = $args[1];
my @keys = @args;
shift @keys;
shift @keys;
shift @keys;

for my $key (@keys) {
  system "$FRED/bin/fred_plot_data -k $key -v $v > fred_multiplot.$key-$$";
}

my $pltfile = "multiplot-$$.plt";
my $pngfile = "multiplot-$$.png";
my $title;
$title = "Cases" if $v eq "C";
$title = "Susceptible" if $v eq "S";
$title = "Exposed" if $v eq "E";
$title = "Infectious" if $v eq "I";
$title = "Recovered" if $v eq "R";
$title = "Symptomatic" if $v eq "s";
$title = "Immune" if $v eq "M";
$title = "Attack Rate" if $v eq "A";
$title = "Clinical Cases" if $v eq "c";
$title = "Reproductive Rate" if $v eq "r";

open FH, ">$pltfile";
print FH <<"EOF";
set title \"FRED: Allegheny County Model \\n$title\"
set terminal png font \"Arial Bold\" 12
# set terminal png font \"Trebuchet MS Bold\" 12
set output \"$pngfile\"
# set terminal aqua font \"Arial,20\"
set grid
set yrange [0:*]
set xrange [0:*]
set xlabel \"Days\" 0,0.5
set ylabel \"Individuals\" 1.2,0
EOF
if ($v eq "A") {
  print FH "set key left Left reverse\n";
  print FH "set ylabel 'Per cent of Population' 1.2,0\n";
}
if ($v eq "r") {
  print FH "set ylabel 'Reproductive Rate' 1.2,0\n";
}

my $n = 0;
for my $k (@keys) {
  print FH ($n == 0)? "plot " : ",\\\n";
  $n++;
  print FH "\"fred_multiplot.$k-$$\" using  1:2 title \"$k\" with lines lw 3 lt $n";
}
print FH "\n";
close FH;
system ($gnuplot,$pltfile);
# system ("open $pngfile");
print "$pngfile\n";
# unlink $pngfile;
# unlink $pltfile;
# unlink "fred_multiplot.*";

exit;


