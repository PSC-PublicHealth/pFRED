#!/usr/bin/perl
use strict;
use warnings;
use Env;
use Getopt::Std;

my $FRED = $ENV{FRED_HOME};
die "Please set environmental variable FRED_HOME to location of FRED source directory\n" if not $FRED;
my $bindir = "$FRED/bin";

my %opts = ();
getopts("k:r:a:d:", \%opts);
my $key = $opts{k} or die "usage: fred_chain -k key -r run -a agent -d depth\n";
my $run = $opts{r} or die "usage: fred_chain -k key -r run -a agent -d depth\n";
my $agent = $opts{a} or die "usage: fred_chain -k key -r run -a agent -d depth\n";
my $maxdepth = $opts{d} or die "usage: fred_chain -k key -r run -a agent -d depth\n";

my $id = `$bindir/get_id $key`;
chomp $id;
die "get_plot: UNKNOWN key: $key\n" if $id eq "UNKNOWN";

my $status = `$bindir/get_status $key`;
chomp $status;
$status =~ s/\s.*//;
die "get_plot: bad status: $status\n" if $status ne "FINISHED";

my $reports = "$FRED/RESULTS/EXP/$id/DATA/REPORTS";
my $out = "$FRED/RESULTS/EXP/$id/DATA/OUT";

chdir $reports or die "Can't find REPORTS directory: $reports\n";

open IN, "$out/trace$run.txt";
my %infects = ();
my %line = ();
while (my $trace = <IN>) {
  my @a = split " ", $trace;
  my $n = $a[3];
  my $infector = $a[21];
  $infects{$infector} = "" if not exists $infects{$infector};
  $infects{$infector} .= " $n";
  $line{$n} = $trace;
}
close IN;

my %depth = ();
$depth{$agent} = 0;
print $line{$agent};
exit if not exists $infects{$agent};
my @r = split (" ",$infects{$agent});
my @q = ();
for my $x (@r) {
  next if $x eq "";
  push @q, $x;
  $depth{$x} = 1;
}
while (@q) {
  my $z = shift @q;
  next if $z eq "";
  print $line{$z};
  next if not exists $infects{$z};
  my @r = split (" ",$infects{$z});
  for my $x (@r) {
    next if $x eq "";
    $depth{$x} = $depth{$z}+1;
    push @q, $x if $depth{$x} <= $maxdepth;
  }
}

