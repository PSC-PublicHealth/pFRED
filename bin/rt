#!/bin/bash

# echo 'the rt regression test is temporarily disabled - JG'
# exit

# look for the FRED binary
FRED="./FRED"
if [ ! -x $FRED -a -x $FRED_HOME/src/FRED ]; then
    cd $FRED_HOME/src
fi

# sanity checks
[ ! -d OUT.TEST ]          && mkdir -p OUT.TEST
[ -e OUT.TEST/out1.txt ]   && rm -f OUT.TEST/out*
[ -e OUT.TEST/infections1.txt ] && rm -f OUT.TEST/infections*
if [ ! -x $FRED ]; then
    echo "No FRED binary found (either ./FRED or \$FRED_HOME/src/FRED)"
    echo ">>> You must either build FRED or properly define FRED_HOME"
    exit 1
fi

# run the regression test
echo -n regression test running ... run 1  
if [ "$1" = "-p" ]; then
  echo -n " (in background) ..."
  ($FRED params.test 1 > OUT.TEST/LOG1) &
  R1=$!
else
  echo -n ...
  $FRED params.test 1 > OUT.TEST/LOG1
  R1=$?
fi

echo -n run 2 ...
$FRED params.test 2 > OUT.TEST/LOG2
wait $R1
echo
echo comparing results ...

# check the results
cmp OUT.TEST/out1.txt OUT.RT/out1.txt
cmp OUT.TEST/out2.txt OUT.RT/out2.txt
cmp OUT.TEST/infections1.txt OUT.RT/infections1.txt
cmp OUT.TEST/infections2.txt OUT.RT/infections2.txt

# done
echo regression test finished.
