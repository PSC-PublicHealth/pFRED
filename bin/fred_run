#!/usr/bin/perl
use strict;
use warnings;
use Env;
use Cwd;
use Fcntl qw(:flock);
use Getopt::Std;
$| = 1;  # AUTO_FLUSH

# File: run_fred
# Author: John Grefenstette
# Created: Jan 12, 2010
# Updated: Apr 7, 2010

# get current working directory
my $cwd = getcwd();

my $FRED = $ENV{FRED_HOME};
die "run_fred: Please set environmental variable FRED_HOME to location of FRED source directory\n" if not $FRED;

# get command line arguments
my %options = ();
getopts("p:k:", \%options);
my $paramsfile;
$paramsfile = $options{p} if exists $options{p};
my $key;
$key = $options{k} if exists $options{k};
$paramsfile = "params" if not $paramsfile;

# make a temp copy of the params file
# my ($paramsfile, $key) = @ARGV;
# $paramsfile = "params" if not $paramsfile;
die "run_fred: Bad params file name\n" if $paramsfile =~ /;/;
my $params = "/tmp/params.$$";
die "run_fred: Can't find params file $paramsfile\n" if not -e $paramsfile;
system "cp $paramsfile $params";

# NOTE: the rest of the script runs in the FRED_HOME directory
chdir $FRED or die "Can't change to FRED directory $FRED\n";

# set locking semaphore
my $SEMAPHORE = ".results.lck";
open(SEM, ">$SEMAPHORE") || die "run_fred failed to obtain semaphore: ($!)\n";
flock(SEM, LOCK_EX);

# compile FRED if necessary
system "make -s";

# create RESULTS directory if needed
my $fred_results = "$FRED/RESULTS";
if (not -d $fred_results) {
  mkdir "$fred_results" or (close SEM and die "Can't create RESULTS directory\n");
}

# create RESULTS/EXP directory if needed
if (not -d "$fred_results/EXP") {
  mkdir "$fred_results/EXP" or (close SEM and die "Can't create $fred_results/EXP directory\n");
}

# create $fred_results/ID file if needed
if (not -e "$fred_results/ID") {
  open FH, ">$fred_results/ID" or (close SEM and die "Can't create file $fred_results/ID\n");
  print FH "1\n";
  close FH;
}

# create $fred_results/KEY file if needed
if (not -e "$fred_results/KEY") {
  open FH, ">$fred_results/KEY" or (close SEM and die "Can't create file $fred_results/KEY\n");
  close FH;
}

# get id for this experiment and update counter
open FH, "$fred_results/ID";
my $id = <FH>;
chomp $id;
# print "id = |$id|\n";
close FH;
my $new_id = $id + 1;
open FH, ">$fred_results/ID";
print FH "$new_id\n";
close FH;

# use experiment id unless given command line key
$key = $id if not defined $key;

# determine if key is unique. if so, add to list
open FH, "$fred_results/KEY";
my $mapping = ();
while (<FH>) {
  chomp;
  my ($k) = split;
  if ($k eq $key) {
    close SEM and close FH and die "run_fred: key $key already used.\n";
  }
}
close FH;
open FH, ">>$fred_results/KEY";
print FH "$key $id\n";
close FH;

# release semaphore
close SEM;

my $dir = "$fred_results/EXP/$id";
die "run_fred: ID $id already used\n" if -d $dir;

# make directory for this experiment
mkdir $dir or die "Can't make directory $dir\n";

# make directories for output
my $data = "$dir/DATA";
mkdir $data or die "Can't make directory $data\n";

my $out = "$data/OUT";
mkdir $out or die "Can't make directory $out\n";

my $reports = "$data/REPORTS";
mkdir $reports or die "Can't make directory $reports\n";

# record meta data about this run
my $meta = "$dir/META";
mkdir $meta or die "Can't make directory $meta\n";

# update run status
`echo SETUP > $meta/STATUS`;

# return run_key
print "$id\n";

my $datefile = "$meta/DATE";
`date > $datefile`; 

my $userfile = "$meta/USER";
my $user = $ENV{USER};
`echo $user > $userfile`;

`hostname > $meta/WHERE`;

my $cmdfile = "$meta/COMMAND";
`echo ./FRED $paramsfile > $cmdfile`; 

my $logfile = "$meta/LOG";

# copy source code
my $version = "$meta/VERSION";
mkdir $version or die "Can't make directory $version\n";
`cp -p Makefile profiles.txt *.cc *.h params* test_* LICENSE $version`;
`cp $params $version/$paramsfile`;

# redirect output parameters
`./ch outfile $out/out $params >> $logfile`;
`./ch tracefile $out/trace $params >> $logfile`;

# update run status
`echo RUNNING > $meta/STATUS`;

# finally, run FRED
# system "./FRED $params | tee -a $logfile";
system "./FRED $params > $logfile";
# unlink $params;

# process output files
system "$FRED/bin/stats $out/out* > $reports/stats.out";

my @fields = qw/S E I R I_s M AR/;
for my $x (@fields) {
  open OUT, ">$reports/$x.dat";
  open IN, "$reports/stats.out";
  while (my $line = <IN>) {
    my @a = split " ", $line;
    for my $i (0..$#a) {
      if ($a[$i] eq $x) {
	print OUT "$a[1] $a[$i+1] $a[$i+2]\n";
	last;
      }
    }
  }
  close IN;
  close OUT;
}

# update run status
`echo FINISHED > $meta/STATUS`;

# return to original directory
chdir $cwd;

exit;

