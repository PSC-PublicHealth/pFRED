#!/usr/bin/perl
use strict;
use warnings;
use Env;
use Getopt::Long qw(:config no_ignore_case bundling);

my %titles = ( AR => "Attack Rate",
	       C => "Cases",
	       CAR => "Clinical Attack Rate",
	       CI => "Clinical Incidents",
	       Cls => "Classroom Transmissions",
	       E => "Exposed",
	       H => "Household Transmissions",
	       I => "Infectious",
	       I_s => "Symptomatics",
	       M => "Immune",
	       N => "Pop Size",
	       Off => "Office Transmissions",
	       R => "Recovered",
	       RR => "Reproductive Rate",
	       S => "Susceptible",
	       Sch => "School Transmissions",
	       SM => "Seasonality Mult",
	       Wrk => "Workplace Transmissions",
	       X => "Imported Transmissions",
	       small => "Presenteeism at Small Workplaces",
	       med => "Presenteeism at Medium Workplaces",
	       large => "Presenteeism at Large Workplaces",
	       xlarge => "Presenteeism at Xlarge Workplaces",
);

my @keys = ();
my @varlist = ();
my $year = "0";
my $xmin = "0";
my $xmax = "*";
my $ymin = "0";
my $ymax = "*";
my $errorbars;
my $title = "FRED: Allegheny County Model";
# my $fontsize = "giant";
# my $fontsize = "large";
my $fontsize = "medium";

my $opt_result = GetOptions("e" => \$errorbars,
			    "f=s" => \$fontsize,
			    "k=s" => \@keys,
			    "v=s" => \@varlist,
			    "a=i" => \$year,
			    "x=i" => \$xmin,
			    "X=i" => \$xmax,
			    "y=i" => \$ymin,
			    "Y=i" => \$ymax,
			    "T=s" => \$title);

my $usage = "usage: fred_plots -k key [-k key ...] -v [-a start_year|-e|-f fontsize|-x xmin|-y ymin|-X xmax|-Y ymax|-T title]\n";

die $usage if not @keys;
die $usage if not @varlist;

my $FRED = $ENV{FRED_HOME};
die "Please set environmental variable FRED_HOME to location of FRED home directory\n" if not $FRED;

my $gnuplot = $ENV{FRED_GNUPLOT};
die "no gnuplot\n" if (not $gnuplot or (not -x $gnuplot));

my $v = $varlist[0];
my $titlevar = $v;
$titlevar = $titles{$v} if exists $titles{$v};
for my $key (@keys) {
  system "$FRED/bin/fred_plot_data -k $key -v $v > fred_plots.$key-$$";
}

my $pltfile = "plots-$$.plt";
my $pngfile = "plots-$$.png";


open FH, ">$pltfile";
print FH <<"EOF";
set title \"$title\\n$titlevar\"
set terminal png $fontsize
set output \"$pngfile\"
# set terminal aqua font \"Arial,20\"
set grid
set yrange [0:*]
set xrange [0:*]
set xlabel \"Days\" offset 0,0.5
set ylabel \"Individuals\" offset 1.2,0
EOF
if ($v eq "AR") {
  print FH "set key left Left reverse\n";
  print FH "set ylabel 'Per cent of Population' offset 1.2,0\n";
}
if ($v eq "RR") {
  print FH "set ylabel 'Reproductive Rate' offset 1.2,0\n";
}

for my $n (0..$#keys) {
  my $k = $keys[$n];
  my $name = $k;
  $name = $titles{$k} if exists $titles{$k};
  print FH ($n == 0)? "plot " : ",\\\n";
  print FH "\"fred_plots.$k-$$\" using  1:2 title \"$name\" with lines lw 3 lt ", $n+1;
}
print FH "\n";
close FH;
system ($gnuplot,$pltfile);
# system ("open $pngfile");
print "$pngfile\n";
# unlink $pngfile;
# unlink $pltfile;
# unlink "fred_plots.*";

exit;


