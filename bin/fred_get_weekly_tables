#!/usr/bin/perl

# file : fred_get_weekly_tables

my ($tables) = @ARGV;
$tables = "TABLES" if not $tables;
mkdir $tables if not -e $tables;
exit if not -d $tables;

# get the list of files
my $filelist = `ls $tables/0/*`;
chomp $filelist;
my @files = split " ", $filelist;
# print "|@files|\n";

# get the list of run numbers
my %run_numbers = ();
for my $file (@files) {
  next if ($file !~ /daily/);
  my ($run) = ($file =~/(\d+)\.txt/);
  $run_numbers{$run} = 1;
}

# get the list of variables
my %vars = ();
for my $file (@files) {
  next if ($file !~ /daily/);
  my ($var) = ($file =~/.*\/(.*)_daily-\d+\.txt/);
  $vars{$var} = 1;
}

# my @a = sort keys %vars;
# print "vars: @a\n";
# @a = sort keys %run_numbers;
# print "run_numbers: @a\n";
# exit;

for my $key (sort keys %vars) {
  for my $run (sort keys %run_numbers) {
    # loop over all strains
    my $strain = 0;
    my $dir = "$tables/$strain";
    while (-d $dir) {
      my $dfile = "$dir/$key\_daily-$run.txt";
      open IN, "$dfile" or die "Can't open dfile\n";
      my $wfile = "$dir/$key\_weekly-$run.txt";
      # print "dfile = $dfile   wfile = $wfile\n";
      open OUT, ">$wfile";
      print OUT "WEEK YEAR POP WKDAYS SIMWEEK $key\n";

      my $sum = 0;
      my $size = 0;
      my $lineno = 1;
      my $oldweek = -1;
      my $oldyear = -1;
      my $day;
      my $week;
      my $year;
      my $n;
      my $x;
      $x = <IN>;
      while (<IN>) {
	chomp;
	($day, $week, $year, $n, $x) = split " ";
	if ($week ne $oldweek) {
	  if ($size > 0) {
	    print OUT "$oldweek $oldyear $n $size $lineno ", (1.0*$sum)/$size, "\n";
	    $lineno++;
	  }
	  $sum = $x;
	  $size = 1;
	  $oldweek = $week;
	  $oldyear = $year;
	} 
	else {
	  $sum = $sum + $x;
	  $size++;
	}
      }
      close IN;
      print OUT "$oldweek $oldyear $n $size $lineno ", (1.0*$sum)/$size, "\n";
      close OUT;
      $strain++;
      $dir = "$tables/$strain";
    }
  }
}



  
